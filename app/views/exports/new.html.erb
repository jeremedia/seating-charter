<% content_for :title, "Configure Export" %>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Configure Export</h1>
    <nav class="mt-2" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        <li><%= link_to @cohort.name, cohort_path(@cohort), class: "hover:text-gray-700" %></li>
        <li>›</li>
        <li><%= link_to @seating_event.name, cohort_seating_event_path(@cohort, @seating_event), class: "hover:text-gray-700" %></li>
        <li>›</li>
        <li><%= link_to "Exports", cohort_seating_event_exports_path(@cohort, @seating_event), class: "hover:text-gray-700" %></li>
        <li>›</li>
        <li class="text-gray-900">Configure</li>
      </ol>
    </nav>
  </div>

  <!-- Arrangement Info -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
    <div class="flex items-start">
      <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
      </svg>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-blue-900">
          <%= @seating_arrangement.multi_day? ? @seating_arrangement.day_name : "Seating Arrangement" %>
        </h3>
        <div class="mt-1 text-sm text-blue-700">
          <%= @seating_arrangement.students_count %> students •
          <%= @seating_arrangement.tables_count %> tables •
          Score: <%= @seating_arrangement.formatted_score %>
          <% if @seating_arrangement.has_explanations? %>
            • Explanations available
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Form -->
  <%= form_with url: cohort_seating_event_seating_arrangement_exports_path(@cohort, @seating_event, @seating_arrangement), 
                method: :post, 
                local: true, 
                id: "export-form",
                class: "space-y-8" do |form| %>

    <!-- Format Selection -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Export Format</h3>
        <p class="mt-1 text-sm text-gray-500">Choose the format for your export</p>
      </div>
      <div class="px-4 py-5 sm:px-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <% @formats.each do |format| %>
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="format" 
                     value="<%= format %>" 
                     class="sr-only format-radio"
                     <%= 'checked' if format == params[:format] %>
                     onchange="updateFormatOptions('<%= format %>')">
              <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors format-option">
                <div class="flex items-center">
                  <%= format_icon(format) %>
                  <h4 class="ml-2 font-medium text-gray-900"><%= format.humanize %></h4>
                </div>
                <p class="mt-2 text-sm text-gray-600"><%= format_description(format) %></p>
                <div class="mt-3">
                  <span class="text-xs font-medium text-blue-600"><%= format_features(format) %></span>
                </div>
              </div>
            </label>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Layout Options -->
    <div class="bg-white shadow rounded-lg" id="layout-options">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Layout & Formatting</h3>
        <p class="mt-1 text-sm text-gray-500">Customize the appearance of your export</p>
      </div>
      <div class="px-4 py-5 sm:px-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <%= form.label :layout, "Layout Style", class: "block text-sm font-medium text-gray-700" %>
            <%= form.select :layout,
                options_for_select([
                  ["Standard - Balanced overview", "standard"],
                  ["Detailed - Complete information", "detailed"],
                  ["Compact - Space efficient", "compact"]
                ], @export_options[:layout]),
                { include_blank: false },
                { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
          </div>

          <div>
            <%= form.label :paper_size, "Paper Size", class: "block text-sm font-medium text-gray-700" %>
            <%= form.select :paper_size,
                options_for_select([
                  ["Letter (8.5\" x 11\")", "LETTER"],
                  ["A4 (210mm x 297mm)", "A4"],
                  ["Legal (8.5\" x 14\")", "LEGAL"]
                ], @export_options[:paper_size]),
                { include_blank: false },
                { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
          </div>
        </div>

        <!-- Format-specific options will be inserted here by JavaScript -->
        <div id="format-specific-options" class="mt-6">
          <!-- Populated by JavaScript based on selected format -->
        </div>
      </div>
    </div>

    <!-- Content Options -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Content Options</h3>
        <p class="mt-1 text-sm text-gray-500">Choose what to include in your export</p>
      </div>
      <div class="px-4 py-5 sm:px-6">
        <div class="space-y-4">
          <div class="flex items-center justify-between py-2">
            <div class="flex-1">
              <label for="include_explanations" class="font-medium text-gray-700">Seating Explanations</label>
              <p class="text-sm text-gray-500">Include AI-generated explanations for seating decisions</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <%= form.check_box :include_explanations, 
                  { checked: @export_options[:include_explanations], class: "sr-only" },
                  "1", "0" %>
              <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-2">
            <div class="flex-1">
              <label for="include_diversity_report" class="font-medium text-gray-700">Diversity Analysis</label>
              <p class="text-sm text-gray-500">Include diversity metrics and distribution charts</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <%= form.check_box :include_diversity_report, 
                  { checked: @export_options[:include_diversity_report], class: "sr-only" },
                  "1", "0" %>
              <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-2">
            <div class="flex-1">
              <label for="include_photos" class="font-medium text-gray-700">Student Photos</label>
              <p class="text-sm text-gray-500">Include student profile photos if available</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <%= form.check_box :include_photos, 
                  { checked: @export_options[:include_photos], class: "sr-only" },
                  "1", "0" %>
              <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-2">
            <div class="flex-1">
              <label for="include_qr_code" class="font-medium text-gray-700">QR Code</label>
              <p class="text-sm text-gray-500">Add QR code linking to online seating chart</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <%= form.check_box :include_qr_code, 
                  { checked: @export_options[:include_qr_code], class: "sr-only" },
                  "1", "0" %>
              <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Branding Options -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Branding</h3>
        <p class="mt-1 text-sm text-gray-500">Customize the branding and appearance</p>
      </div>
      <div class="px-4 py-5 sm:px-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <%= form.label "branding[organization_name]", "Organization Name", class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_field "branding[organization_name]", 
                value: @branding_options[:organization_name],
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
          </div>

          <div>
            <%= form.label "branding[header_text]", "Header Text", class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_field "branding[header_text]", 
                value: @branding_options[:header_text],
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
          </div>

          <div>
            <%= form.label "branding[primary_color]", "Primary Color", class: "block text-sm font-medium text-gray-700" %>
            <div class="mt-1 flex items-center space-x-2">
              <%= form.color_field "branding[primary_color]", 
                  value: @branding_options[:primary_color],
                  class: "block w-16 h-10 rounded border-gray-300" %>
              <%= form.text_field "branding[primary_color]", 
                  value: @branding_options[:primary_color],
                  class: "block flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
            </div>
          </div>

          <div>
            <%= form.label "branding[secondary_color]", "Secondary Color", class: "block text-sm font-medium text-gray-700" %>
            <div class="mt-1 flex items-center space-x-2">
              <%= form.color_field "branding[secondary_color]", 
                  value: @branding_options[:secondary_color],
                  class: "block w-16 h-10 rounded border-gray-300" %>
              <%= form.text_field "branding[secondary_color]", 
                  value: @branding_options[:secondary_color],
                  class: "block flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview & Export Actions -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:px-6">
        <div class="flex items-center justify-between">
          <div>
            <button type="button" 
                    onclick="showPreview()" 
                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              Preview
            </button>
          </div>
          
          <div class="flex space-x-3">
            <%= link_to "Cancel", 
                cohort_seating_event_exports_path(@cohort, @seating_event),
                class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
            
            <button type="button" 
                    onclick="emailExport()" 
                    class="inline-flex items-center px-4 py-2 border border-blue-600 shadow-sm text-sm font-medium rounded-md text-blue-600 bg-white hover:bg-blue-50">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
              Email Export
            </button>
            
            <%= form.submit "Generate Export", 
                class: "inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
          </div>
        </div>
      </div>
    </div>

  <% end %>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-full overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">Export Preview</h3>
        <button type="button" onclick="hidePreview()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="preview-content" class="px-6 py-4">
        <!-- Preview content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
// Format option templates
const formatOptions = {
  csv: `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="csv_format" class="block text-sm font-medium text-gray-700">CSV Format</label>
        <select name="csv_format" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="full">Full - All available data</option>
          <option value="roster">Roster - Basic student info</option>
          <option value="summary">Summary - Event overview</option>
          <option value="assignments">Assignments - Table details</option>
          <option value="diversity">Diversity - Analysis data</option>
        </select>
      </div>
    </div>
  `,
  name_tags: `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="name_tag_format" class="block text-sm font-medium text-gray-700">Tag Format</label>
        <select name="name_tag_format" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="avery_5395">Avery 5395 (30 per sheet)</option>
          <option value="avery_74459">Avery 74459 (10 per sheet)</option>
          <option value="table_tent">Table Tents (4 per sheet)</option>
          <option value="badge_large">Large Badges (8 per sheet)</option>
        </select>
      </div>
      <div>
        <label for="name_tag_style" class="block text-sm font-medium text-gray-700">Style</label>
        <select name="name_tag_style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="standard">Standard - Full info</option>
          <option value="badge">Badge - Professional</option>
          <option value="table_tent">Table Tent - Folded</option>
          <option value="simple">Simple - Name only</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <div class="flex items-center space-x-6">
          <label class="flex items-center">
            <input type="checkbox" name="include_table_number" value="1" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="ml-2 text-sm text-gray-700">Include table numbers</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" name="include_organization_on_tent" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="ml-2 text-sm text-gray-700">Show organizations on tents</span>
          </label>
        </div>
      </div>
    </div>
  `,
  powerpoint: `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="presentation_style" class="block text-sm font-medium text-gray-700">Presentation Style</label>
        <select name="presentation_style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="slides">Slides - Full presentation</option>
          <option value="handout">Handout - Printed format</option>
          <option value="speaker_notes">Speaker Notes - With notes</option>
        </select>
      </div>
      <div class="flex items-center">
        <label class="flex items-center">
          <input type="checkbox" name="detailed_table_slides" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
          <span class="ml-2 text-sm text-gray-700">Include detailed table slides</span>
        </label>
      </div>
    </div>
  `
};

function updateFormatOptions(format) {
  const container = document.getElementById('format-specific-options');
  const formatSpecific = formatOptions[format];
  
  if (formatSpecific) {
    container.innerHTML = formatSpecific;
    container.style.display = 'block';
  } else {
    container.innerHTML = '';
    container.style.display = 'none';
  }
  
  // Update format option styling
  document.querySelectorAll('.format-option').forEach(option => {
    option.classList.remove('border-blue-500', 'bg-blue-50');
    option.classList.add('border-gray-200');
  });
  
  const selectedOption = document.querySelector(`input[value="${format}"]`).parentElement.querySelector('.format-option');
  selectedOption.classList.remove('border-gray-200');
  selectedOption.classList.add('border-blue-500', 'bg-blue-50');
}

function showPreview() {
  const form = document.getElementById('export-form');
  const formData = new FormData(form);
  
  // Add preview parameter
  formData.append('preview', 'true');
  
  // Show loading state
  document.getElementById('preview-content').innerHTML = `
    <div class="flex items-center justify-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <span class="ml-3 text-gray-600">Generating preview...</span>
    </div>
  `;
  
  document.getElementById('preview-modal').classList.remove('hidden');
  
  // Make preview request
  fetch('<%= preview_cohort_seating_event_seating_arrangement_exports_path(@cohort, @seating_event, @seating_arrangement) %>', {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    }
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('preview-content').innerHTML = renderPreview(data);
  })
  .catch(error => {
    document.getElementById('preview-content').innerHTML = `
      <div class="text-center py-8">
        <div class="text-red-600">Preview failed: ${error.message}</div>
      </div>
    `;
  });
}

function hidePreview() {
  document.getElementById('preview-modal').classList.add('hidden');
}

function renderPreview(data) {
  if (data.error) {
    return `<div class="text-red-600">${data.error}</div>`;
  }
  
  let html = `<div class="space-y-4">`;
  html += `<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">`;
  html += `<h4 class="font-medium text-blue-900">Format: ${data.format.toUpperCase()}</h4>`;
  
  if (data.sections) {
    html += `<div class="mt-3"><h5 class="font-medium text-blue-800">Sections:</h5><ul class="mt-1 space-y-1">`;
    data.sections.forEach(section => {
      html += `<li class="text-sm text-blue-700">• ${section.name}: ${section.description}</li>`;
    });
    html += `</ul></div>`;
    html += `<p class="mt-3 text-sm text-blue-700">Estimated pages: ${data.estimated_pages}</p>`;
  }
  
  if (data.worksheets) {
    html += `<div class="mt-3"><h5 class="font-medium text-blue-800">Worksheets:</h5><ul class="mt-1 space-y-1">`;
    data.worksheets.forEach(sheet => {
      html += `<li class="text-sm text-blue-700">• ${sheet.name}: ${sheet.description}</li>`;
    });
    html += `</ul></div>`;
  }
  
  if (data.slides) {
    html += `<div class="mt-3"><h5 class="font-medium text-blue-800">Slides (${data.estimated_slides}):</h5><ul class="mt-1 space-y-1">`;
    data.slides.forEach(slide => {
      html += `<li class="text-sm text-blue-700">• ${slide.title}: ${slide.content}</li>`;
    });
    html += `</ul></div>`;
  }
  
  html += `</div></div>`;
  return html;
}

function emailExport() {
  const email = prompt('Enter email address:', '<%= current_user.email %>');
  if (email) {
    const form = document.getElementById('export-form');
    const formData = new FormData(form);
    formData.append('recipient_email', email);
    
    fetch('<%= email_export_cohort_seating_event_seating_arrangement_exports_path(@cohort, @seating_event, @seating_arrangement) %>', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(response => response.json())
    .then(data => {
      alert(`Export will be emailed to ${email}`);
    })
    .catch(error => {
      alert('Failed to queue email export');
    });
  }
}

// Initialize format options on page load
document.addEventListener('DOMContentLoaded', function() {
  const checkedRadio = document.querySelector('input[name="format"]:checked');
  if (checkedRadio) {
    updateFormatOptions(checkedRadio.value);
  }
});
</script>