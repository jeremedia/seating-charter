<% content_for :title, "Students - #{@cohort.name}" %>

<div class="max-w-7xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Students</h1>
        <p class="text-gray-600 mt-1"><%= @cohort.name %></p>
        <p class="text-sm text-gray-500 mt-1"><%= pluralize(@students.count, 'student') %> total</p>
      </div>
      
      <div class="flex space-x-3">
        <%= link_to 'Add Student', new_cohort_student_path(@cohort), 
              class: 'inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm text-sm font-medium hover:bg-blue-700' %>
        <%= link_to 'Back to Cohort', cohort_path(@cohort), 
              class: 'inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50' %>
      </div>
    </div>
  </div>

  <!-- Students Table -->
  <div class="bg-white shadow rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Organization</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Attributes</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden xl:table-cell">AI Confidence</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @students.each do |student| %>
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3">
              <div class="flex items-center">
                <div class="h-8 w-8 flex-shrink-0 hidden sm:block">
                  <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                    <span class="text-xs font-medium text-gray-700">
                      <%= student.name.split(' ').map(&:first).join('').upcase[0..1] %>
                    </span>
                  </div>
                </div>
                <div class="sm:ml-3">
                  <div class="text-sm font-medium text-gray-900"><%= student.name %></div>
                  <div class="text-xs text-gray-500"><%= student.location %></div>
                </div>
              </div>
            </td>
            <td class="px-4 py-3">
              <div class="text-sm text-gray-900"><%= student.title || '-' %></div>
            </td>
            <td class="px-4 py-3 hidden lg:table-cell">
              <div class="text-sm text-gray-900"><%= student.organization || '-' %></div>
            </td>
            <td class="px-4 py-3 hidden md:table-cell">
              <div class="flex flex-wrap gap-1">
                <% if student.inferences && student.inferences['gender'] %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-pink-100 text-pink-800">
                    <%= student.inferences['gender']['value'] %>
                  </span>
                <% end %>
                <% if student.inferences && student.inferences['agency_level'] %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                    <%= student.inferences['agency_level']['value'] %>
                  </span>
                <% end %>
                <% if student.inferences && student.inferences['department_type'] %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                    <%= student.inferences['department_type']['value'] %>
                  </span>
                <% end %>
                <% if student.inferences && student.inferences['seniority_level'] %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                    <%= student.inferences['seniority_level']['value'] %>
                  </span>
                <% end %>
              </div>
            </td>
            <td class="px-4 py-3 hidden xl:table-cell">
              <% if student.inferences && student.inferences.any? %>
                <% avg_confidence = student.inferences.values.map { |v| v['confidence'] }.compact.sum.to_f / student.inferences.values.compact.size %>
                <div class="flex items-center">
                  <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                    <div class="bg-green-600 h-2 rounded-full" style="width: <%= (avg_confidence * 100).round %>%"></div>
                  </div>
                  <span class="text-xs text-gray-600"><%= (avg_confidence * 100).round %>%</span>
                </div>
              <% else %>
                <span class="text-xs text-gray-400">No AI data</span>
              <% end %>
            </td>
            <td class="px-4 py-3 text-right">
              <div class="flex gap-2 justify-end">
                <%= link_to 'Edit', edit_cohort_student_path(@cohort, student), 
                      class: 'text-sm text-blue-600 hover:text-blue-900' %>
                <span class="text-gray-300">|</span>
                <%= link_to 'Remove', cohort_student_path(@cohort, student), 
                      method: :delete,
                      data: { confirm: 'Are you sure you want to remove this student?' },
                      class: 'text-sm text-red-600 hover:text-red-900' %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    </div>
    
    <% if @students.empty? %>
      <div class="text-center py-12">
        <div class="text-gray-400 text-4xl mb-4">ðŸ‘¥</div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No students yet</h3>
        <p class="text-gray-500 mb-4">Add students to this cohort to get started.</p>
        <%= link_to 'Add First Student', new_cohort_student_path(@cohort), 
              class: 'inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm text-sm font-medium hover:bg-blue-700' %>
      </div>
    <% end %>
  </div>

  <!-- Summary Stats -->
  <% if @students.any? %>
    <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6">
      <!-- Gender Distribution -->
      <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-sm font-medium text-gray-900 mb-3">Gender Distribution</h3>
        <% gender_counts = @students.map { |s| s.inferences&.dig('gender', 'value') }.compact.group_by(&:itself).transform_values(&:count) %>
        <% if gender_counts.any? %>
          <div class="space-y-2">
            <% gender_counts.each do |gender, count| %>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600"><%= gender.capitalize %></span>
                <span class="text-sm font-medium text-gray-900"><%= count %></span>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-400">No data</p>
        <% end %>
      </div>

      <!-- Agency Level -->
      <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-sm font-medium text-gray-900 mb-3">Agency Levels</h3>
        <% agency_counts = @students.map { |s| s.inferences&.dig('agency_level', 'value') }.compact.group_by(&:itself).transform_values(&:count) %>
        <% if agency_counts.any? %>
          <div class="space-y-2">
            <% agency_counts.each do |level, count| %>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600"><%= level.capitalize %></span>
                <span class="text-sm font-medium text-gray-900"><%= count %></span>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-400">No data</p>
        <% end %>
      </div>

      <!-- Department Types -->
      <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-sm font-medium text-gray-900 mb-3">Department Types</h3>
        <% dept_counts = @students.map { |s| s.inferences&.dig('department_type', 'value') }.compact.group_by(&:itself).transform_values(&:count).first(3) %>
        <% if dept_counts.any? %>
          <div class="space-y-2">
            <% dept_counts.each do |type, count| %>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600 truncate"><%= type.humanize %></span>
                <span class="text-sm font-medium text-gray-900"><%= count %></span>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-400">No data</p>
        <% end %>
      </div>

      <!-- AI Confidence -->
      <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-sm font-medium text-gray-900 mb-3">AI Confidence</h3>
        <% students_with_ai = @students.select { |s| s.inferences && s.inferences.any? } %>
        <% if students_with_ai.any? %>
          <% all_confidences = students_with_ai.flat_map { |s| s.inferences.values.map { |v| v['confidence'] } }.compact %>
          <% avg_confidence = (all_confidences.sum.to_f / all_confidences.size * 100).round %>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Average</span>
              <span class="text-sm font-medium text-gray-900"><%= avg_confidence %>%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">With AI Data</span>
              <span class="text-sm font-medium text-gray-900"><%= students_with_ai.count %>/<%= @students.count %></span>
            </div>
          </div>
        <% else %>
          <p class="text-sm text-gray-400">No data</p>
        <% end %>
      </div>
    </div>
  <% end %>
</div>